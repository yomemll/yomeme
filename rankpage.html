<!doctype thml>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ë­í‚¹(top50)</title>
    <style>
        :root {
            --max-w: 600px;
        }
        body {
            margin: 0;
            font-family: system-ui, -apple-system, segoe UI, Roboto, 'Noto sans KR, Arial, sans-serif';
            background-color: #202020;
            color: #ffffff;
        }

        .wrap {
            margin: 0 auto;
            padding: 24px 16px 48px;
        }

        .header {
            max-width: var(--max-w);
            margin: 0 auto 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .title {
            font-weight: 800;
            font-size: 20px;
        }

        .sub {
            color: #202020;
            font-size: 12px;
        }

        .card{
            max-width: var(--max-w);
            margin: 0 auto;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 12px 14px;
            border-bottom: 1px solid #000000;
            background: #000000;
        }

        .btn {
            appearance: none;
            border: 0;
            padding: 8px 12px;
            border-radius: 10px;
            background: #75ff26;
            color: #000000;
            font-weight: 700;
            cursor: pointer;
        }

        .btn:active {
            transform: translateY(1px);
        }

        #btnback:hover {
            animation: wobble 0.45s ease-in-out;
        }

        @keyframes wobble {
            0%   { transform: rotate(0deg); }
            25%  { transform: rotate(3deg); }
            50%  { transform: rotate(-3deg); }
            75%  { transform: rotate(2deg); }
            100% { transform: rotate(0deg); }
        }

        .ghost {
            background: #75ff26;
            color: #000000;
        }

        #btnRefresh:hover {
            animation: wobble 0.45s ease-in-out;
        }

        .table-wrap {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead th {
            position: sticky; top: 0;
            background: #000000;
            color: #ffffff;
            font-weight: 800;
            text-align: left;
            padding: 12px 10px;
            border-bottom: 1px solid #000000;
            z-index: 1;
        }

        tbody th{
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }

        tbody tr:nth-child(odd) { background: #f2f7ff; }

        tbody tr:hover { background: #f2f7ff; }

        .rank {
            font-weight: 900;
            font-size: 22px;
            width: 76px;
            letter-spacing: 0.2px;
        }

        .rank.top1 {color: #ffffff;}
        .rank.top2 {color: #ffee00;}
        .rank.top3 {color: #d39b00;}

        tr.row-1 {background: #303030 !important;}
        tr.row-2 {background: #000000 !important;}
        tr.row-3 {background: #303030 !important;}
        tr.row-4 {background: #000000 !important;}
        tr.row-5 {background: #303030 !important;}
        tr.row-6 {background: #000000 !important;}
        tr.row-7 {background: #303030 !important;}
        tr.row-8 {background: #000000 !important;}
        tr.row-9 {background: #303030 !important;}
        tr.row-10 {background: #000000 !important;}

        .hl { background: #000000 !important;}

        .footer {
            max-width: var(--max-w);
            margin: 14px auto 0;
            color: #00c569;
            font-size: 12px;
            line-height: 1.4;
            padding: 0 2px;
        }

        @media (max-width: 769px) { .wrap { width: var(--max-w);}}
        @media (max-width: 768px) { .wrap {width: 100%;}}
    </style>
</head>
<body>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            let hue = 0;
            setInterval(chroma, 16);

            function chroma() {
                const top = document.querySelector("tr.row-1");
                if (top) top.style.color = `hsl(${hue}, 100%, 50%)`;

                const top2 = document.querySelector(".rank.top1");
                if (top2) top2.style.color = `hsl(${hue}, 100%, 50%)`;

                const sc2 = document.querySelector("tr.row-2");
                if (sc2) sc2.style.color = 'yellow';

                const sc3 = document.querySelector("tr.row-3");
                if (sc3) sc3.style.color = '#d39b00';

                hue = (hue + 1) % 360;
            }
        });
    </script>

    <div class="wrap">
        <div class="header">
            <div>
                <div class="title">ğŸŒë­í‚¹ top50</div>
                <div class="sub">ê¸°ë¡ì´ ì‘ì„ìˆ˜ë¡ ë” ë†’ì€ ìˆœìœ„ì˜ˆìš” (ë‹¨ìœ„:ì´ˆ)<div>
            </div>
        <div>
        <div class="card">
            <div class="toolbar">
                <button class="btn ghost" id="btnRefresh">ìƒˆë¡œê³ ì¹¨</button>
                <button class="btn" id="btnBack">ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
            <div class="table-wrap">
                <table aria-label="ë­í‚¹ í‘œ">
                    <thead>
                        <tr>
                            <th class="rank">ìˆœìœ„</th>
                            <th>ì•„ì´ë””</th>
                            <th>ê¸°ë¡(ì´ˆ)</th>
                            <th>ì €ì¥ì‹œê°</th>
                        </tr>
                    </thead>
                    <tbody id="rankBody">
                        <tr><td colspan="4">ë¶ˆëŸ¬ì˜¤ëŠ”ì¤‘...</tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="footer">
            *ë™ì ì¼ ê²½ìš° ì €ì¥ìˆœì„œë¡œ ì •ë ¬ë¨ë‹ˆë‹¤.<br>
            *ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” firestore ë³´ì•ˆ ê·œì¹™ì„ ê¼­ ì ìš©í•˜ì„¸ìš”
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>

    <script>
        var firebaseconfig = {
            aapiKey: "AIzaSyDbQDi4OKM_7k93TmyL2UI8ixEDpjVzmuw",
            authDomain: "webgm-db.firebaseapp.com",
            projectId: "webgm-db",
            storageBucket: "webgm-db.firebasestorage.app",
            messagingSenderId: "51095430771",
            appId: "1:51095430771:web:138f83f74337fc46792c06",
        }

        firebase.initializeApp(firebaseconfig);
        var db = firebase.firestore()

        function getQueryParam(name) {
            var Query = location.search.replace(/^\?/, '');
            var parts = Query.split('&');
            for (var i = 0; i < parts.length; i++) {
                var kv = parts[i].split('=');
                if (decodeURIComponent(kv[0])===name) {
                    return kv[i] ? decodeURIComponent(kv[1]) : '';
                }
            }
            return null;
        }
        var lastId = getQueryParam('lastId');
        var lastTime = getQueryParam('lastTime');

        function to2(n) {
            if (typeof n !== 'number' || !isFinite(n)) return '';
            return n.toFixed(2);
        }

        function fmtDate(ts) {
            if (!ts || !ts.toDate) return'';
            var d = ts.toDate();

            var y = d.getFullYear();
            var m = d.getMonth() + 1;
            var day = d.getDate();
            var hh = d.getHours();
            var mm = d.getMinutes();

            if (m<10) m = '0' +m;
            if (day<10) day = '0' +day;
            if (hh<10) hh = '0' +hh;
            if (mm<10) mm = '0' +mm;

            return y + '-' + m + '-' + day + ' ' + hh + ':' + mm;
        }

        function escapeHtml(s) {
            s = String(s);
            s = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            s = s.replace(/"/g,'&quot;').replace(/'/g, '&#39;');
            return s;
        }

        function loadRanking() {
            var body = document.getElementById('rankBody');

            body.innerHTML = '<tr><td colspan="4">ë¶ˆëŸ¬ì˜¤ëŠ”ì¤‘...</td></tr>';

            db.collection('scores')
            .orderBy('time', 'asc')
            .limit(50)
            .get()
            .then(function(snapshot) {
                var html = '';
                var rank = 0;

                snapshot.forEach(function(doc) {
                    var data = doc.data() || {};
                    var userId = data.userId || '';
                    var time = Number(data.time);
                    var createdAt = data.createdAt || null;

                    rank = rank + 1;

                    var medal = '';
                    if (rank === 1) {medal = 'ğŸŒ '; }
                    else if (rank === 2) {medal = 'ğŸ›¸ '; }
                    else if (rank === 3) {medal = 'ğŸ‘½ '; }

                    var rowClass = '';
                    if (rank <= 10) {rowClass = 'row-' + rank; }

                    var isHL = false;
                    if (lastId !== null && lastTime !== null) {
                        if (String(userId) === String(lastId) &&
                            to2(Number(time)) === to2(Number(lastTime))) {
                            isHL = true;
                        }
                    }

                    var rankClass = '';
                    if (rank === 1) rankClass = 'top1';
                    else if (rank === 2) rankClass = 'top2';
                    else if (rank === 3) rankClass = 'top3';
                    
                    html += '<tr class="' + (isHL ? 'hl ' : '') + rowClass + '">';
                    html +=     '<td class="rank ' + rankClass + '">' + medal + rank + '</td>';
                    html +=     '<td>' + escapeHtml(userId) + '</td>';
                    html +=     '<td>' + to2(time) + '</td>';
                    html +=     '<td>' + fmtDate(createdAt) + '</td>';
                    html += '</tr>';
                });
                
                if (html === '') {
                    body.innerHTML = '<tr><td colspan="4">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                } else {
                    body.innerHTML = html;
                }
            })
            .catch(function(err) {
                console.error(err);
                body.innerHTML = '<tr><td colspan="4" style="color:#c00;">ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê·œì¹™/ë„¤íŠ¸ì›Œí¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.</td></tr>';
            });
        }

        document.getElementById('btnRefresh').onclick = function() {
            loadRanking();
        };
        document.getElementById('btnBack').onclick = function() {
            location.href = "canvas_js_exam_1_15ì°½ì‘.html";
        };
        loadRanking();
    </script>
</body>
</html>